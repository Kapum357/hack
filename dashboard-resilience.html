<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>RCU Soacha - Dashboard de Resiliencia Climática</title>
    <link rel="stylesheet" href="/styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .risk-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .risk-high { background-color: #dc2626; color: white; }
        .risk-medium { background-color: #f59e0b; color: white; }
        .risk-low { background-color: #10b981; color: white; }
        .alert-box {
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid;
            border-radius: 4px;
            background-color: rgba(255,255,255,0.05);
        }
        .alert-high { border-left-color: #dc2626; }
        .alert-medium { border-left-color: #f59e0b; }
        .alert-low { border-left-color: #10b981; }
        .stat-card {
            background: linear-gradient(135deg, rgba(0,36,104,0.1) 0%, rgba(59,130,246,0.1) 100%);
            border: 1px solid rgba(59,130,246,0.2);
            padding: 16px;
            border-radius: 8px;
            margin: 8px 0;
        }
        .zone-marker {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .zone-marker:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark overflow-x-hidden">
<div class="layout-container flex h-full grow flex-col">

<!-- Header -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-white/10 dark:border-white/10 px-6 sm:px-10 py-3 bg-background-light dark:bg-background-dark/80 backdrop-blur-sm sticky top-0 z-10">
    <div class="flex items-center gap-4 text-slate-800 dark:text-white">
        <div class="size-6 text-blue-600">
            <span class="material-symbols-outlined">public</span>
        </div>
        <h2 class="text-slate-800 dark:text-white text-lg font-bold leading-tight tracking-tight">RCU Soacha - Resiliencia Climática Urbana</h2>
    </div>
    <div class="flex items-center justify-end gap-2">
        <button id="refresh-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-blue-600 text-white text-sm font-bold leading-normal tracking-wide hover:bg-blue-700 transition-colors">
            <span class="material-symbols-outlined mr-1">refresh</span>
            Actualizar
        </button>
        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2750%27 fill=%27%23002468%27/%3E%3Ctext x=%2750%27 y=%2750%27 text-anchor=%27middle%27 dy=%27.3em%27 fill=%27white%27 font-size=%2740%27%3ERCU%3C/text%3E%3C/svg%3E");'></div>
    </div>
</header>

<!-- Main Content -->
<main class="flex-1 px-4 sm:px-6 md:px-10 py-5">
<div class="layout-content-container flex flex-col w-full mx-auto">

<!-- Title Section -->
<div class="mb-4">
    <h2 class="text-slate-800 dark:text-white text-2xl font-bold leading-tight tracking-tight mb-2">Dashboard de Análisis de Vulnerabilidad</h2>
    <p class="text-slate-600 dark:text-slate-400 text-sm">Monitoreo de riesgo climático e impacto poblacional en Soacha</p>
</div>

<!-- Metrics Grid -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="stat-card">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-xs font-medium mb-1">Población en Riesgo</p>
                <p id="population-at-risk" class="text-slate-900 dark:text-white text-2xl font-bold">9,600</p>
            </div>
            <span class="material-symbols-outlined text-blue-500 text-2xl">group</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-xs font-medium mb-1">Zonas de Alto Riesgo</p>
                <p id="high-risk-zones" class="text-slate-900 dark:text-white text-2xl font-bold">2</p>
            </div>
            <span class="material-symbols-outlined text-red-500 text-2xl">warning</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-xs font-medium mb-1">Reportes Comunitarios</p>
                <p id="total-reports" class="text-slate-900 dark:text-white text-2xl font-bold">0</p>
            </div>
            <span class="material-symbols-outlined text-amber-500 text-2xl">description</span>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-slate-600 dark:text-slate-400 text-xs font-medium mb-1">Alertas Activas</p>
                <p id="active-alerts" class="text-slate-900 dark:text-white text-2xl font-bold">0</p>
            </div>
            <span class="material-symbols-outlined text-red-600 text-2xl">notifications_active</span>
        </div>
    </div>
</div>

<!-- Main Grid: Map + Analysis -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Map -->
    <div class="lg:col-span-2 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4 flex flex-col gap-4">
        <div class="flex justify-between items-center">
            <h3 class="text-lg font-bold text-slate-800 dark:text-white">Mapa de Vulnerabilidad</h3>
            <div class="text-xs text-slate-500 dark:text-slate-400">Soacha, Colombia</div>
        </div>
        <div id="map" class="w-full aspect-video rounded-lg z-0" style="min-height: 500px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
    </div>
    
    <!-- Vulnerability Analysis -->
    <div class="rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4 flex flex-col gap-4 overflow-y-auto max-h-[600px]">
        <h3 class="text-lg font-bold text-slate-800 dark:text-white">Análisis de Vulnerabilidad</h3>
        <div id="vulnerability-zones-list" class="space-y-3">
            <!-- Dynamically populated -->
        </div>
    </div>
</div>

<!-- Alerts Section -->
<div class="rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4 mb-6">
    <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">
        <span class="material-symbols-outlined inline mr-2">priority_high</span>
        Alertas Preventivas
    </h3>
    <div id="alerts-container" class="space-y-2">
        <div class="text-slate-500 dark:text-slate-400 text-sm">Cargando alertas...</div>
    </div>
</div>

<!-- Weather & Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Weather -->
    <div class="rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4">
        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">
            <span class="material-symbols-outlined inline mr-2">cloud</span>
            Condiciones Climáticas Actuales
        </h3>
        <div id="weather-info" class="space-y-3">
            <div class="text-slate-500 dark:text-slate-400 text-sm">Obteniendo datos...</div>
        </div>
    </div>
    
    <!-- Population Distribution Chart -->
    <div class="rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-4">
        <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Población por Zona</h3>
        <canvas id="populationChart" style="max-height: 300px;"></canvas>
    </div>
</div>

</div>
</main>

</div>
</div>

<script>
const API_BASE = window.location.origin + '/api';

// Initialize Map
const map = L.map('map').setView([4.58, -74.21], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Define zone colors
const riskColors = {
    'high': '#dc2626',
    'medium': '#f59e0b',
    'low': '#10b981'
};

// Load all data
async function loadDashboardData() {
    try {
        // Fetch multiple endpoints in parallel
        const [popStats, vulnAnalysis, weatherData, reportsGeoJSON] = await Promise.all([
            fetch(`${API_BASE}/population-stats`).then(r => r.json()),
            fetch(`${API_BASE}/vulnerability`).then(r => r.json()),
            fetch(`${API_BASE}/weather`).then(r => r.json()),
            fetch(`${API_BASE}/reports-export`).then(r => r.json()).catch(e => {console.log('No reports yet'); return {features: []};})
        ]);
        
        // Update summary metrics
        updateMetrics(popStats, vulnAnalysis, weatherData);
        
        // Visualize zones on map
        visualizeVulnerabilityZones(vulnAnalysis);
        
        // Add community reports to map
        if (reportsGeoJSON.features && reportsGeoJSON.features.length > 0) {
            addReportsToMap(reportsGeoJSON);
        }
        
        // Update vulnerability panel
        displayVulnerabilityAnalysis(vulnAnalysis);
        
        // Update weather info
        displayWeatherInfo(weatherData);
        
        // Update alerts
        displayAlerts(weatherData);
        
        // Create charts
        createPopulationChart(popStats);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

function updateMetrics(popStats, vulnAnalysis, weatherData) {
    document.getElementById('population-at-risk').textContent = 
        popStats.at_risk_population?.toLocaleString() || '0';
    document.getElementById('high-risk-zones').textContent = popStats.high_risk_zones || '0';
    document.getElementById('total-reports').textContent = popStats.total_reports || '0';
    document.getElementById('active-alerts').textContent = popStats.total_alerts || '0';
}

function visualizeVulnerabilityZones(vulnAnalysis) {
    Object.entries(vulnAnalysis).forEach(([zoneName, zoneData]) => {
        const [lat, lng] = zoneData.coordinates;
        const color = riskColors[zoneData.risk_level] || '#666';
        
        // Create circle marker
        const radius = 5000; // 5 km
        L.circle([lat, lng], {
            color: color,
            fillColor: color,
            fillOpacity: 0.2,
            weight: 2,
            radius: radius
        }).addTo(map).bindPopup(`
            <div style="color: #000; font-weight: bold;">${zoneName.toUpperCase()}</div>
            <div style="color: #666;">Riesgo: ${zoneData.risk_level}</div>
            <div style="color: #666;">Población: ${zoneData.population_at_risk.toLocaleString()}</div>
            <div style="color: #666;">Score de Riesgo: ${zoneData.risk_score}</div>
        `);
        
        // Add marker
        L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'zone-marker',
                html: `<div style="background: ${color}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                    <span class="material-symbols-outlined" style="font-size: 16px;">location_on</span>
                </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map);
    });
}

function addReportsToMap(geojson) {
    L.geoJSON(geojson, {
        pointToLayer: (feature, latlng) => {
            return L.circleMarker(latlng, {
                radius: 6,
                fillColor: '#3b82f6',
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).bindPopup(`
                <div style="color: #000;">
                    <strong>${feature.properties.event_type || 'Evento'}</strong><br/>
                    <small>${feature.properties.date || 'Fecha desconocida'}</small><br/>
                    ${feature.properties.description || ''}
                </div>
            `);
        }
    }).addTo(map);
}

function displayVulnerabilityAnalysis(vulnAnalysis) {
    const container = document.getElementById('vulnerability-zones-list');
    container.innerHTML = '';
    
    Object.entries(vulnAnalysis).forEach(([zoneName, data]) => {
        const html = `
            <div class="border-l-4" style="border-left-color: ${riskColors[data.risk_level]}; padding-left: 12px;">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-slate-800 dark:text-white capitalize">${zoneName}</h4>
                    <span class="risk-badge risk-${data.risk_level}">${data.risk_level.toUpperCase()}</span>
                </div>
                <div class="text-sm text-slate-600 dark:text-slate-400 space-y-1">
                    <div>Población: <strong>${data.population_at_risk.toLocaleString()}</strong></div>
                    <div>Score Riesgo: <strong>${data.risk_score}</strong>/100</div>
                    <div class="text-xs mt-2">Cobertura de Intervenciones:</div>
                    <div class="text-xs ml-2">
                        • Cohesión social: ${data.interventions.social_cohesion}%<br/>
                        • Gestión de riesgo: ${data.interventions.disaster_risk_mgmt}%<br/>
                        • Cambio climático: ${data.interventions.climate_change}%
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += html;
    });
}

function displayWeatherInfo(weatherData) {
    const container = document.getElementById('weather-info');
    
    if (weatherData && weatherData.current_weather) {
        const w = weatherData.current_weather;
        const html = `
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded">
                    <div class="text-sm text-slate-600 dark:text-slate-400">Temperatura</div>
                    <div class="text-2xl font-bold text-slate-900 dark:text-white">${w.temperature}°C</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded">
                    <div class="text-sm text-slate-600 dark:text-slate-400">Humedad</div>
                    <div class="text-2xl font-bold text-slate-900 dark:text-white">${w.humidity}%</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded">
                    <div class="text-sm text-slate-600 dark:text-slate-400">Precipitación</div>
                    <div class="text-2xl font-bold text-slate-900 dark:text-white">${w.precipitation}mm</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded">
                    <div class="text-sm text-slate-600 dark:text-slate-400">Condición</div>
                    <div class="text-lg font-bold text-slate-900 dark:text-white">${w.weather}</div>
                </div>
            </div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-2">
                Actualizado: ${new Date(w.timestamp).toLocaleString('es-CO')}
            </div>
        `;
        container.innerHTML = html;
    } else {
        container.innerHTML = '<div class="text-slate-500 dark:text-slate-400 text-sm">No hay datos climáticos disponibles</div>';
    }
}

function displayAlerts(weatherData) {
    const container = document.getElementById('alerts-container');
    const alerts = weatherData?.recent_alerts || [];
    
    if (alerts.length === 0) {
        container.innerHTML = '<div class="text-green-600 dark:text-green-400 text-sm font-medium">✓ No hay alertas activas</div>';
        return;
    }
    
    container.innerHTML = alerts.map(alert => {
        const severityClass = {
            'high': 'alert-high',
            'medium': 'alert-medium',
            'low': 'alert-low'
        }[alert.severity] || 'alert-low';
        
        return `
            <div class="alert-box ${severityClass}">
                <div class="flex justify-between items-start mb-2">
                    <span class="font-semibold text-slate-800 dark:text-white capitalize">${alert.type}</span>
                    <span class="text-xs font-bold px-2 py-1 rounded" style="background-color: rgba(0,0,0,0.2);">
                        ${alert.severity.toUpperCase()}
                    </span>
                </div>
                <div class="text-sm text-slate-700 dark:text-slate-300">${alert.message}</div>
                ${alert.affected_zones ? `
                    <div class="text-xs text-slate-600 dark:text-slate-400 mt-2">
                        Zonas afectadas: ${alert.affected_zones.join(', ')}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function createPopulationChart(popStats) {
    const ctx = document.getElementById('populationChart');
    if (!ctx) return;
    
    const zones = Object.keys(popStats.by_zone || {});
    const populations = zones.map(z => popStats.by_zone[z].population);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: zones.map(z => z.replace('_', ' ').toUpperCase()),
            datasets: [{
                label: 'Población por Zona',
                data: populations,
                backgroundColor: '#3b82f6',
                borderColor: '#002468',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#9ca3af' : '#374151' }
                },
                x: {
                    ticks: { color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#9ca3af' : '#374151' }
                }
            }
        }
    });
}

// Refresh functionality
document.getElementById('refresh-btn').addEventListener('click', loadDashboardData);

// Auto-refresh every 5 minutes
setInterval(loadDashboardData, 5 * 60 * 1000);

// Initial load
window.addEventListener('load', loadDashboardData);
</script>

</body>
</html>
