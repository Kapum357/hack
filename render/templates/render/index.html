<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soacha Resiliencia Climática</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        #map { height: 80vh; width: 100%; }
        .sidebar { height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Cruz Roja - Soacha RCU</a>
  </div>
</nav>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-3 sidebar">
            <h5>Capas de Información</h5>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="layerInundacion" checked>
                <label class="form-check-label" for="layerInundacion">
                    Amenaza Inundación
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="layerVulnerabilidad">
                <label class="form-check-label" for="layerVulnerabilidad">
                    Vulnerabilidad Social
                </label>
            </div>
            <hr>
            <h5>Estadísticas</h5>
            <p>Personas afectadas: <span id="stats-affected">0</span></p>
            <p>Familias vinculadas: <span id="stats-linked">0</span></p>
        </div>
        <div class="col-md-9">
            <div id="map"></div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script>
    // Initialize map centered on Soacha
    var map = L.map('map').setView([4.580, -74.220], 13);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Example marker
    var marker = L.marker([4.580, -74.220]).addTo(map);
    marker.bindPopup("<b>Soacha Centro</b><br>Punto de referencia.").openPopup();

    // Layer groups for managing layers
    var floodLayer = L.layerGroup();
    var vulnerabilityLayer = L.layerGroup();

    // Load GeoJSON layers from API
    
    // Fetch flood threat layer
    fetch('/api/layers/inundacion')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                style: function(feature) {
                    // Color based on threat level
                    var color;
                    switch(feature.properties.threat_level) {
                        case 'VERY_HIGH': color = '#d73027'; break;
                        case 'HIGH': color = '#fc8d59'; break;
                        case 'MEDIUM': color = '#fee08b'; break;
                        case 'LOW': color = '#91bfdb'; break;
                        default: color = '#999999';
                    }
                    return {
                        fillColor: color,
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.5
                    };
                },
                onEachFeature: function(feature, layer) {
                    var popupContent = '<b>' + feature.properties.name + '</b><br>';
                    popupContent += 'Nivel de amenaza: ' + feature.properties.threat_level + '<br>';
                    if (feature.properties.description) {
                        popupContent += feature.properties.description;
                    }
                    layer.bindPopup(popupContent);
                }
            }).addTo(floodLayer);
            
            // Add to map by default (checkbox is checked)
            floodLayer.addTo(map);
        })
        .catch(error => console.error('Error loading flood layer:', error));

    // Fetch vulnerability layer
    fetch('/api/layers/vulnerabilidad')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                style: function(feature) {
                    // Color based on vulnerability index (0 to 1)
                    var index = feature.properties.vulnerability_index;
                    var color;
                    if (index >= 0.75) color = '#d73027';
                    else if (index >= 0.5) color = '#fc8d59';
                    else if (index >= 0.25) color = '#fee08b';
                    else color = '#91bfdb';
                    
                    return {
                        fillColor: color,
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.6
                    };
                },
                onEachFeature: function(feature, layer) {
                    var props = feature.properties;
                    var popupContent = '<b>' + props.name + '</b><br>';
                    if (props.vulnerability_index != null) {
                        popupContent += 'Índice de vulnerabilidad: ' + props.vulnerability_index.toFixed(2) + '<br>';
                    }
                    popupContent += 'Población afectada: ' + props.affected_population + '<br>';
                    popupContent += 'Familias vinculadas: ' + props.linked_families + '<br>';
                    if (props.description) {
                        popupContent += props.description;
                    }
                    layer.bindPopup(popupContent);
                }
            }).addTo(vulnerabilityLayer);
            
            // Update statistics
            updateStatistics(data);
        })
        .catch(error => console.error('Error loading vulnerability layer:', error));

    // Layer toggle handlers
    document.getElementById('layerInundacion').addEventListener('change', function(e) {
        if (e.target.checked) {
            floodLayer.addTo(map);
        } else {
            map.removeLayer(floodLayer);
        }
    });

    document.getElementById('layerVulnerabilidad').addEventListener('change', function(e) {
        if (e.target.checked) {
            vulnerabilityLayer.addTo(map);
        } else {
            map.removeLayer(vulnerabilityLayer);
        }
    });

    // Update statistics from vulnerability data
    function updateStatistics(geojsonData) {
        var totalAffected = 0;
        var totalLinked = 0;
        
        if (geojsonData.features) {
            geojsonData.features.forEach(function(feature) {
                totalAffected += feature.properties.affected_population || 0;
                totalLinked += feature.properties.linked_families || 0;
            });
        }
        
        document.getElementById('stats-affected').textContent = totalAffected.toLocaleString();
        document.getElementById('stats-linked').textContent = totalLinked.toLocaleString();
    }
</script>

</body>
</html>